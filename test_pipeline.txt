PUT _ingest/pipeline/shodan_monitor_pipeline
{
  "description": "Normalize Shodan Monitor fields (server/dest, geo, alert info)",
  "processors": [
    {
      "date": {
        "ignore_failure": true,
        "formats": [
          "yyyy-MM-dd'T'HH:mm:ss.SSSSSS"
        ],
        "field": "timestamp"
      }
    },
    {
      "set": {
        "field": "event.module",
        "value": "shodan"
      }
    },
    {
      "set": {
        "field": "event.dataset",
        "value": "shodan.monitor"
      }
    },
    {
      "set": {
        "field": "event.kind",
        "value": "event"
      }
    },
    {
      "set": {
        "field": "observer.vendor",
        "value": "Shodan"
      }
    },
    {
      "set": {
        "field": "observer.type",
        "value": "scanner"
      }
    },
    {
      "rename": {
        "field": "shodan.ip_str",
        "target_field": "server.ip",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "shodan.port",
        "target_field": "server.port",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "shodan.transport",
        "target_field": "network.transport"
      }
    },
    {
      "convert": {
        "ignore_missing": true,
        "field": "server.port",
        "type": "integer"
      }
    },
    {
      "convert": {
        "field": "shodan.location.latitude",
        "type": "float",
        "target_field": "server.geo.location.latitude",
        "ignore_missing": true
      }
    },
    {
      "convert": {
        "field": "shodan.location.longitude",
        "type": "float",
        "target_field": "server.geo.location.longitude",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "shodan._shodan.alert.id",
        "target_field": "rule.id",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "field": "shodan._shodan.alert.name",
        "target_field": "rule.name",
        "ignore_missing": true
      }
    },
    {
      "rename": {
        "ignore_missing": true,
        "field": "_shodan.module",
        "target_field": "shodan.module"
      }
    },
    {
      "rename": {
        "field": "shodan.asn",
        "target_field": "server.as.number",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "shodan.org",
        "target_field": "server.as.organization.name",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "set": {
        "field": "server.geo.region_iso_code",
        "value": "{{shodan.location.country_code}}-{{shodan.location.region_code}}"
      }
    },
    {
      "rename": {
        "field": "shodan.location.city",
        "target_field": "server.geo.city_name",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "shodan.location.country_name",
        "target_field": "server.geo.country_name",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "shodan.location.country_name",
        "target_field": "server.geo.country_name",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "location.region_code",
        "target_field": "server.geo.region_code",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "shodan.location.country_name",
        "target_field": "server.geo.country_name",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "shodan.location.country_code",
        "target_field": "server.geo.country_iso_code",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "shodan.hostnames",
        "target_field": "server.address",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "shodan.domains",
        "target_field": "server.registered_domain",
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "rename": {
        "field": "shodan._shodan",
        "target_field": "_shodan"
      }
    },
    {
      "foreach": {
        "field": "_shodan",
        "processor": {
          "rename": {
            "field": "_ingest._key",
            "target_field": "shodan.{{_ingest._key}}",
            "ignore_failure": true,
            "override": true
          }
        }
      }
    },
    {
      "remove": {
        "field": [
          "_shodan",
          "timestamp",
          "transport",
          "as",
          "location",
          "shodan.ip",
          "shodan.location"
        ],
        "ignore_missing": true
      }
    },
    {
      "script": {
        "source": "\n      for (entry in ((Map)ctx._shodan).entrySet()) {\n        sh[entry.getKey()] = entry.getValue();   // e.g. alert -> {...}, module -> \"dns-udp\"\n      }\n      ctx.shodan = sh;\n      ctx.remove('_shodan');\n"
      }
    }
  ],
  "on_failure": [
    {
      "set": {
        "field": "error.message",
        "value": "{{ _ingest.on_failure_message }}"
      }
    }
  ]
}